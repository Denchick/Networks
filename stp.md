# Канальный уровень 2. STP

Протокол связующего (остовного) дерева (Spanning Tree Protocol, STP) позволяет автоматически отключать дублирующие соединений в Ethernet, чтобы в сети не образовалось кольца и широковещательного шторма.

#### Описание протокола 

Протокол работает на канальном уровне. STP позволяет делать топологию избыточной на физическом уровне, но при этом логически блокировать петли. Достигается это с помощью того, что STP отправляет сообщения BPDU и обнаруживает фактическую топологию сети. А затем, определяя роли коммутаторов и портов, часть портов блокирует так, чтобы в итоге получить топологию без петель.

Для того чтобы определить какие порты заблокировать, а какие будут передавать данные, STP выполняет следующее:

1. Выбор корневого моста (Root Bridge)
2. Определение корневых портов (Root Port)
3. Определение выделенных портов (Designated Port)

#### Выбор активного пути STP

Порт коммутатора, который имеет кратчайший путь к корневому коммутатору, называется корневым портом. У любого не корневого коммутатора может быть только один корневой порт. Корневой порт выбирается на основе меньшего Root Path Cost - это общее значение стоимости всех линков до корневого коммутатора. Если стоимость линков до корневого коммутатора совпадает, то выбор корневого порта происходит на основе меньшего Bridge ID коммутатора. Если и Bridge ID коммутаторов до корневого коммутатора совпадает, то тогда корневой порт выбирается на основе Port ID.

####Выбор корневого коммутатора 

Корневым становится коммутатор с наименьшим идентификатором моста (Bridge ID).

Только один коммутатор может быть корневым. Для того чтобы выбрать корневой коммутатор, все коммутаторы отправляют сообщения BPDU, указывая себя в качестве корневого коммутатора. Если коммутатор получает BPDU от коммутатора с меньшим Bridge ID, то он перестает анонсировать информацию о том, что он корневой и начинает передавать BPDU коммутатора с меньшим Bridge ID.

В итоге только один коммутатор останется корневым и будет передавать BPDU.

Изначально **Bridge ID** состоял из двух полей:

- **Приоритет** — поле, которое позволяет административно влиять на выборы корневого коммутатора. Размер — 2 байта,
- **MAC-адрес** — используется как уникальный идентификатор, который, в случае совпадения значений приоритетов, позволяет выбрать корневой коммутатор. Так как MAC-адреса уникальны, то и Bridge ID уникален, так что какой-то коммутатор обязательно станет корневым.

#### **Отличия тегированного Vlan от нетегерированного**

**VLAN** — **Virtual Local Area Network**. Суть технологии заключается в том, что к сетевому кадру (2-й уровень) прибавляется дополнительный заголовок (**tag**), который содержит служебную информацию и **VLAN ID**. Сети с разными **VLAN ID** недоступны друг другу, как если бы они были выполнены из отдельных кабелей и устройств. Значения **VLAN ID** могут быть от 1 — 4095. При этом 1 зарезервирована как **VLAN** по умолчанию или default.

Исходя из этого **логично предположить** что есть трафик тегированный и нетегированный. 

Тегированный трафик (с идентификатором влана) идет между коммутаторами и серверами. Обычные же компьютеры не понимают тегированный трафик. 

Поэтому на тех портах, которые смотрят непосредственно на рабочие станции или в сеть с неуправляемым коммутатором, выдается нетегированный трафик. Т.е. от сетевого кадра отрезается тег. Это также происходит, если на порту настроен **VLAN ID = 1**.
